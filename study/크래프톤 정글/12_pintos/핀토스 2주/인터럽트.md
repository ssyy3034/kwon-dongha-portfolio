---
date: 2025-11-13
tags: [CS]
---

# 3. 인터럽트의 기본 처리 흐름 (핵심)

인터럽트가 발생하는 순간 CPU는 다음을 수행한다.

### (1) 현재 실행 흐름 저장

CPU는 자동으로 아래 상태를 스택에 저장한다:

- RIP (다음 실행할 명령의 주소)
    
- CS
    
- RFLAGS
    
- SS, RSP (유저→커널 전환 시)
    

이것이 **트랩 프레임(trap frame)** 또는 **intr_frame**이 된다.

### (2) 권한 레벨 변화 (필요 시)

유저모드 → 커널모드로 진입

- 스택 포인터가 자동으로 TSS의 커널 스택으로 전환됨
    
- SS, CS 세그먼트도 커널 값으로 변경
    

### (3) IDT(Interrupt Descriptor Table)를 보고 핸들러 주소로 점프

IDT 엔트리는:

- handler 주소
    
- privilege(DPL)
    
- gate type
    
- interrupt/trap flag
    

CPU는 그 엔트리에 지정된 커널 코드로 점프.

### (4) OS 커널 핸들러 실행

예:

- Timer interrupt → 스케줄러 tick 증가 → preemption
    
- Keyboard → scancode 읽어 input buffer에 push
    
- Page Fault → faulting VA 확인 → kill or recover
    

### (5) `iretq`로 원래 자리 복귀

핸들러 끝에서 커널은:

`iretq`

CPU는 스택에서:

- RFLAGS
    
- CS
    
- RIP
    
- SS, RSP
    

을 복구하고 유저 모드로 돌아간다.

1. CPU가 #PF 발생
2. intr_entry에서 intr_frame 구성
3. page_fault(intr_frame *f) 호출
4. CR2 내용으로 faulting address 확인
5. error code 비트로 접근 종류 확인
6. user-mode fault인지 검사
7. user-mode fault → exit(-1)
	1. kernel-mode fault → PANIC
exception.c 흐름